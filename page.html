<!DOCTYPE html>
<html lang="th" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            100: '#f3f4f6',
                            200: '#e5e7eb',
                            300: '#d1d5db',
                            400: '#9ca3af',
                            500: '#6b7280',
                            600: '#4b5563',
                            700: '#374151',
                            800: '#1f2937',
                            900: '#111827',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar for dark mode */
        .dark ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        .dark ::-webkit-scrollbar-track {
            background: #374151;
        }

        .dark ::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 6px;
            border: 3px solid #374151;
        }

        .dark ::-webkit-scrollbar-thumb:hover {
            background-color: #6b7280;
        }

        /* Custom scrollbar for light mode */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        ::-webkit-scrollbar-track {
            background: #f3f4f6;
        }

        ::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 6px;
            border: 3px solid #f3f4f6;
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: #9ca3af;
        }
    </style>
</head>

<body class="bg-gray-100 dark:bg-dark-900 min-h-screen text-gray-800 dark:text-gray-200">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î</h1>
            <button id="darkModeToggle"
                class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-dark-700 hover:bg-gray-300 dark:hover:bg-dark-600 transition-colors duration-200">
                <span class="dark:hidden">üåô Dark Mode</span>
                <span class="hidden dark:inline">‚òÄÔ∏è Light Mode</span>
            </button>
        </div>
        <!-- Active Positions -->
        <div class="bg-white dark:bg-dark-800 rounded-lg shadow-lg p-4 mb-6">
            <h2 class="text-xl font-bold mb-4">Active Positions</h2>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 dark:bg-dark-700">
                        <tr>
                            <th class="p-3 text-left font-semibold">Symbol</th>
                            <th class="p-3 text-center font-semibold">Side</th>
                            <th class="p-3 text-right font-semibold">Entry</th>
                            <th class="p-3 text-right font-semibold">Current</th>
                            <th class="p-3 text-right font-semibold">TP1 %</th>
                            <th class="p-3 text-right font-semibold">PNL</th>
                            <th class="p-3 text-right font-semibold">PNL %</th>
                            <th class="p-3 text-center font-semibold">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="active-positions">
                        <tr>
                            <td colspan="8" class="p-4 text-center text-gray-500 dark:text-gray-400">
                                Loading positions...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Fee Settings -->
        <div class="bg-white dark:bg-dark-800 rounded-lg shadow-lg p-4 mb-6">
            <h2 class="text-xl font-bold mb-4">Fee Settings</h2>
            <div class="flex items-center gap-4">
                <div class="flex-1">
                    <label class="block text-sm font-medium mb-2">Trading Fee (%):</label>
                    <input type="number" id="feePercentage" step="0.01" min="0" max="100" placeholder="e.g., 0.1"
                        class="w-full p-2 rounded-lg border border-gray-300 dark:border-dark-600 bg-gray-50 dark:bg-dark-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200">
                </div>
                <div class="flex-1">
                    <label class="block text-sm font-medium mb-2">Status:</label>
                    <div id="feeStatus" class="p-2 text-sm"></div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div>
                <label class="block text-sm font-medium mb-2">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° Symbol:</label>
                <select id="symbolFilter"
                    class="w-full p-2 rounded-lg border border-gray-300 dark:border-dark-600 bg-gray-50 dark:bg-dark-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200">
                    <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:</label>
                <input type="date" id="startDate"
                    class="w-full p-2 rounded-lg border border-gray-300 dark:border-dark-600 bg-gray-50 dark:bg-dark-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200">
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</label>
                <input type="date" id="endDate"
                    class="w-full p-2 rounded-lg border border-gray-300 dark:border-dark-600 bg-gray-50 dark:bg-dark-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200">
            </div>
            <div class="flex items-end">
                <button id="applyFilter"
                    class="w-full p-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors duration-200 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
            </div>
        </div>
        <!-- Summary and Chart -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <!-- Summary -->
            <div class="bg-white dark:bg-dark-800 rounded-lg shadow-lg p-4">
                <h2 class="text-xl font-bold mb-4">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î</h2>
                <div class="grid grid-cols-1 gap-4">
                    <!-- Profit Stats -->
                    <div>
                        <h3 class="text-lg font-semibold mb-2">‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô</h3>
                        <ul class="space-y-2">
                            <li class="p-3 bg-gray-50 dark:bg-dark-700 rounded transition-colors duration-200">
                                <span class="block text-sm text-gray-600 dark:text-gray-400 mb-1">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</span>
                                <span id="daily-profit" class="font-mono text-lg"></span>
                                <span class="block text-xs text-gray-500 mt-1">
                                    ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: <span id="avg-daily-profit" class="font-mono"></span>
                                </span>
                            </li>
                            <li class="p-3 bg-gray-50 dark:bg-dark-700 rounded transition-colors duration-200">
                                <span class="block text-sm text-gray-600 dark:text-gray-400 mb-1">‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</span>
                                <span id="weekly-profit" class="font-mono text-lg"></span>
                                <span class="block text-xs text-gray-500 mt-1">
                                    ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: <span id="avg-weekly-profit" class="font-mono"></span>
                                </span>
                            </li>
                            <li class="p-3 bg-gray-50 dark:bg-dark-700 rounded transition-colors duration-200">
                                <span class="block text-sm text-gray-600 dark:text-gray-400 mb-1">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
                                <span id="monthly-profit" class="font-mono text-lg"></span>
                                <span class="block text-xs text-gray-500 mt-1">
                                    ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: <span id="avg-monthly-profit" class="font-mono"></span>
                                </span>
                            </li>
                            <li class="p-3 bg-gray-50 dark:bg-dark-700 rounded transition-colors duration-200">
                                <span class="block text-sm text-gray-600 dark:text-gray-400 mb-1">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                                <span id="total-profit" class="font-mono text-lg"></span>
                                <span class="block text-xs text-gray-500 mt-1">
                                    ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: <span id="avg-total-profit" class="font-mono"></span>
                                </span>
                            </li>
                        </ul>
                    </div>

                    <!-- Trading Stats -->
                    <div>
                        <h3 class="text-lg font-semibold mb-2">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î</h3>
                        <ul class="space-y-2">
                            <li class="p-3 bg-gray-50 dark:bg-dark-700 rounded transition-colors duration-200">
                                <span class="block text-sm text-gray-600 dark:text-gray-400">Win Rate</span>
                                <span id="win-rate" class="font-mono text-lg"></span>
                            </li>
                            <li class="p-3 bg-gray-50 dark:bg-dark-700 rounded transition-colors duration-200">
                                <span class="block text-sm text-gray-600 dark:text-gray-400">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ó‡∏£‡∏î</span>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <div>
                                        <span class="block text-xs text-gray-500">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</span>
                                        <span id="daily-trades" class="font-mono"></span>
                                    </div>
                                    <div>
                                        <span class="block text-xs text-gray-500">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ:</span>
                                        <span id="weekly-trades" class="font-mono"></span>
                                    </div>
                                    <div>
                                        <span class="block text-xs text-gray-500">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ:</span>
                                        <span id="monthly-trades" class="font-mono"></span>
                                    </div>
                                    <div>
                                        <span class="block text-xs text-gray-500">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
                                        <span id="total-trades" class="font-mono"></span>
                                    </div>
                                </div>
                            </li>
                            <li class="p-3 bg-gray-50 dark:bg-dark-700 rounded transition-colors duration-200">
                                <span class="block text-sm text-gray-600 dark:text-gray-400">‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏ó‡∏£‡∏î</span>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <div>
                                        <span class="block text-xs text-gray-500">‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î:</span>
                                        <span id="max-profit" class="font-mono"></span>
                                    </div>
                                    <div>
                                        <span class="block text-xs text-gray-500">‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î:</span>
                                        <span id="min-profit" class="font-mono"></span>
                                    </div>
                                </div>
                                <div class="mt-1">
                                    <span class="block text-xs text-gray-500">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢:</span>
                                    <span id="avg-profit" class="font-mono"></span>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Chart -->
            <div class="md:col-span-3 bg-white dark:bg-dark-800 rounded-lg shadow-lg p-4">
                <div
                    class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 space-y-2 sm:space-y-0">
                    <h2 class="text-xl font-bold">‡∏Å‡∏£‡∏≤‡∏ü‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∞‡∏™‡∏°</h2>
                    <div class="flex gap-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="chartType" value="date" checked
                                class="form-radio text-blue-500 focus:ring-blue-500 dark:bg-dark-700">
                            <span class="ml-2">‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="chartType" value="trade"
                                class="form-radio text-blue-500 focus:ring-blue-500 dark:bg-dark-700">
                            <span class="ml-2">‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ó‡∏£‡∏î</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="chartType" value="daily"
                                class="form-radio text-blue-500 focus:ring-blue-500 dark:bg-dark-700">
                            <span class="ml-2">‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç</span>
                        </label>
                    </div>
                </div>
                <div class="relative h-[400px]">
                    <canvas id="cumulativeProfitChart"></canvas>
                </div>
            </div>
        </div>
        <!-- Trade Records Table -->
        <div class="bg-white dark:bg-dark-800 rounded-lg shadow-lg p-4">
            <h2 class="text-xl font-bold mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 dark:bg-dark-700">
                        <tr>
                            <th class="p-3 text-left font-semibold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                            <th class="p-3 text-left font-semibold">‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå</th>
                            <th class="p-3 text-left font-semibold">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</th>
                            <th class="p-3 text-right font-semibold">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</th>
                            <th class="p-3 text-right font-semibold">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏≠‡∏Å</th>
                            <th class="p-3 text-right font-semibold">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì</th>
                            <th class="p-3 text-right font-semibold">‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô</th>
                            <th class="p-3 text-right font-semibold">‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô %</th>
                            <th class="p-3 text-left font-semibold">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</th>
                        </tr>
                    </thead>
                    <tbody id="trade-records">
                        <tr>
                            <td colspan="9" class="p-4 text-center text-gray-500 dark:text-gray-400">
                                Loading trades...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="position-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-dark-800 rounded-lg shadow-xl max-w-4xl w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-dark-600">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold" id="modal-title">Position Details</h3>
                    <button class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
                        onclick="closePositionModal()">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Basic Info -->
                    <div>
                        <h4 class="font-semibold mb-4">Position Information</h4>
                        <div class="space-y-3">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="text-gray-600 dark:text-gray-400">Symbol</div>
                                <div id="modal-symbol" class="font-mono"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="text-gray-600 dark:text-gray-400">Side</div>
                                <div id="modal-side" class="font-mono"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="text-gray-600 dark:text-gray-400">Entry Price</div>
                                <div id="modal-entry" class="font-mono"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="text-gray-600 dark:text-gray-400">Current Price</div>
                                <div id="modal-current" class="font-mono"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="text-gray-600 dark:text-gray-400">Stoploss</div>
                                <div id="modal-sl" class="font-mono"></div>
                            </div>
                        </div>
                    </div>
                    <!-- Take Profit Levels -->
                    <div>
                        <h4 class="font-semibold mb-4">Take Profit Levels</h4>
                        <div class="space-y-3">
                            <div class="grid grid-cols-3 gap-4">
                                <div class="text-gray-600 dark:text-gray-400">Level</div>
                                <div class="text-gray-600 dark:text-gray-400">Price</div>
                                <div class="text-gray-600 dark:text-gray-400">Percent</div>
                            </div>
                            <div class="grid grid-cols-3 gap-4">
                                <div>TP1</div>
                                <div id="modal-tp1-price" class="font-mono"></div>
                                <div id="modal-tp1-percent" class="font-mono"></div>
                            </div>
                            <div class="grid grid-cols-3 gap-4">
                                <div>TP2</div>
                                <div id="modal-tp2-price" class="font-mono"></div>
                                <div id="modal-tp2-percent" class="font-mono"></div>
                            </div>
                            <div class="grid grid-cols-3 gap-4">
                                <div>TP3</div>
                                <div id="modal-tp3-price" class="font-mono"></div>
                                <div id="modal-tp3-percent" class="font-mono"></div>
                            </div>
                            <div class="grid grid-cols-3 gap-4">
                                <div>TP4</div>
                                <div id="modal-tp4-price" class="font-mono"></div>
                                <div id="modal-tp4-percent" class="font-mono"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allTrades = [];
        let cumulativeProfitChart;

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
        function formatNumber(number, decimals = 2) {
            return new Intl.NumberFormat('th-TH', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(number);
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Fee
        function getFeePercentage() {
            const feeInput = document.getElementById('feePercentage');
            const feeValue = parseFloat(feeInput.value);
            const feeStatus = document.getElementById('feeStatus');

            if (isNaN(feeValue) || feeValue === 0) {
                feeStatus.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏î‡∏Ñ‡πà‡∏≤ Fee';
                feeStatus.className = 'p-2 text-sm text-gray-500';
                return 0;
            } else if (feeValue < 0 || feeValue > 100) {
                feeStatus.textContent = '‡∏Ñ‡πà‡∏≤ Fee ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (0-100%)';
                feeStatus.className = 'p-2 text-sm text-red-500';
                return 0;
            } else {
                feeStatus.textContent = `‡∏Ñ‡∏¥‡∏î‡∏Ñ‡πà‡∏≤ Fee ${feeValue}%`;
                feeStatus.className = 'p-2 text-sm text-green-500';
                return feeValue;
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal
        function openPositionModal(position) {
            // Basic Info
            $('#modal-title').text(`${position.symbol} Position Details`);
            $('#modal-symbol').text(position.symbol);
            $('#modal-side').text(position.side.toUpperCase())
                .removeClass('text-green-500 text-red-500')
                .addClass(position.side === 'buy' ? 'text-green-500' : 'text-red-500');
            $('#modal-entry').text(formatNumber(position.entryPrice, 4));
            $('#modal-current').text(formatNumber(position.currentPrice, 4));
            $('#modal-sl').text(formatNumber(position.stopPrice, 4));

            // Take Profit Levels
            $('#modal-tp1-price').text(formatNumber(position.tp1Price, 4));
            $('#modal-tp1-percent').text(formatNumber(position.tp1Percent, 2) + '%');
            $('#modal-tp2-price').text(formatNumber(position.tp2Price, 4));
            $('#modal-tp2-percent').text(formatNumber(position.tp2Percent, 2) + '%');
            $('#modal-tp3-price').text(formatNumber(position.tp3Price, 4));
            $('#modal-tp3-percent').text(formatNumber(position.tp3Percent, 2) + '%');
            $('#modal-tp4-price').text(formatNumber(position.tp4Price, 4));
            $('#modal-tp4-percent').text(formatNumber(position.tp4Percent, 2) + '%');

            // Show modal
            $('#position-modal').removeClass('hidden').addClass('flex');
        }

        function closePositionModal() {
            $('#position-modal').removeClass('flex').addClass('hidden');
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
        function calculateStats(trades) {
            const now = new Date();
            const feePercentage = getFeePercentage();

            const stats = {
                total_trades: trades.length,
                winning_trades: 0,
                daily_trades: 0,
                weekly_trades: 0,
                monthly_trades: 0,
                daily_profit: 0,
                weekly_profit: 0,
                monthly_profit: 0,
                total_profit: 0,
                max_profit: -Infinity,
                min_profit: Infinity,
                total_profit_sum: 0
            };

            trades.forEach(trade => {
                const tradeDate = new Date(trade.timestamp);
                const daysDiff = (now - tradeDate) / (1000 * 60 * 60 * 24);

                // Calculate fee amount based on position size
                const entryPositionSize = trade.entry_price * trade.amount;
                const exitPositionSize = trade.exit_price * trade.amount;
                const entryFee = feePercentage ? (entryPositionSize * feePercentage / 100) : 0;
                const exitFee = feePercentage ? (exitPositionSize * feePercentage / 100) : 0;
                const totalFees = entryFee + exitFee;

                // Calculate net profit after fees
                const grossProfit = trade.profit_loss;
                const netProfit = grossProfit - totalFees;

                // Update stats with net profit
                stats.total_profit += netProfit;
                stats.total_profit_sum += netProfit;
                if (netProfit > 0) stats.winning_trades++;
                if (netProfit > stats.max_profit) stats.max_profit = netProfit;
                if (netProfit < stats.min_profit) stats.min_profit = netProfit;

                if (daysDiff <= 1) {
                    stats.daily_trades++;
                    stats.daily_profit += netProfit;
                }
                if (daysDiff <= 7) {
                    stats.weekly_trades++;
                    stats.weekly_profit += netProfit;
                }
                if (daysDiff <= 30) {
                    stats.monthly_trades++;
                    stats.monthly_profit += netProfit;
                }
            });

            // Calculate averages
            stats.win_rate = (stats.winning_trades / stats.total_trades) * 100;
            stats.avg_profit = stats.total_profit_sum / stats.total_trades;
            stats.avg_daily_profit = stats.daily_trades ? stats.daily_profit / stats.daily_trades : 0;
            stats.avg_weekly_profit = stats.weekly_trades ? stats.weekly_profit / stats.weekly_trades : 0;
            stats.avg_monthly_profit = stats.monthly_trades ? stats.monthly_profit / stats.monthly_trades : 0;
            stats.avg_total_profit = stats.total_trades ? stats.total_profit / stats.total_trades : 0;

            return stats;
        }
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Active Positions
        async function updateActivePositions() {
            try {
                const indexResponse = await fetch('json/index.json');
                if (!indexResponse.ok) throw new Error('Cannot load symbols');
                const symbolConfigs = await indexResponse.json();

                let tableContent = '';
                let activePositionsExist = false;

                for (const config of symbolConfigs) {
                    try {
                        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• state
                        const stateResponse = await fetch(`json/state/${config.symbol}.json`);
                        if (!stateResponse.ok) continue;
                        const state = await stateResponse.json();

                        // ‡∏Ç‡πâ‡∏≤‡∏° symbol ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ position
                        if (!state.is_in_position) continue;

                        activePositionsExist = true;

                        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
                        const entryPrice = parseFloat(state.global_position_data.entry_price);
                        const currentPrice = parseFloat(state.current_price || 0);
                        const positionSide = state.global_position_data.position_side;
                        const isLong = positionSide === 'buy';
                        const stopPrice = parseFloat(state.current_stoploss);
                        const positionSize = parseFloat(state.global_position_data.position_size);
                        const leverage = state.global_position_data.leverage || 20;

                        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ATR ‡πÅ‡∏•‡∏∞ TP Levels
                        const atr = state.current_market_data?.atr || 0;
                        const atr_percent = (atr / entryPrice) * 100;

                        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Take Profit Levels
                        const tp_levels = {
                            tp1: {
                                price: isLong ? entryPrice + (atr * 1) : entryPrice - (atr * 1),
                                percent: atr_percent * 1
                            },
                            tp2: {
                                price: isLong ? entryPrice + (atr * 2) : entryPrice - (atr * 2),
                                percent: atr_percent * 2
                            },
                            tp3: {
                                price: isLong ? entryPrice + (atr * 3) : entryPrice - (atr * 3),
                                percent: atr_percent * 3
                            },
                            tp4: {
                                price: isLong ? entryPrice + (atr * 4) : entryPrice - (atr * 4),
                                percent: atr_percent * 4
                            }
                        };

                        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì PNL
                        const pnlPercent = isLong ?
                            ((currentPrice - entryPrice) / entryPrice * 100) :
                            ((entryPrice - currentPrice) / entryPrice * 100);

                        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì PNL ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö USDT
                        const pnlUSDT = isLong ?
                            (currentPrice - entryPrice) * Math.abs(positionSize) :
                            (entryPrice - currentPrice) * Math.abs(positionSize);

                        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ROE (Return on Equity) - Percent gain considering leverage
                        const roe = pnlPercent * leverage;

                        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î CSS classes ‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô
                        const pnlClass = pnlUSDT >= 0 ? 'text-green-500' : 'text-red-500';
                        const sideClass = isLong ? 'text-green-500' : 'text-red-500';

                        // TP hit status
                        const tp_hits = state.tp_levels_hit || {
                            tp1: false,
                            tp2: false,
                            tp3: false,
                            tp4: false
                        };

                        tableContent += `
                <tr class="border-b border-gray-200 dark:border-dark-600 hover:bg-gray-50 dark:hover:bg-dark-700">
                    <td class="p-3 font-semibold">${config.symbol}</td>
                    <td class="p-3 text-center ${sideClass} font-semibold">${positionSide.toUpperCase()}</td>
                    <td class="p-3 text-right font-mono">${formatNumber(entryPrice, 4)}</td>
                    <td class="p-3 text-right font-mono">${formatNumber(currentPrice, 4)}</td>
                    <td class="p-3 text-right font-mono">
                        <div>${tp_hits.tp1 ? '‚úì' : ''} ${formatNumber(tp_levels.tp1.percent, 2)}%</div>
                    </td>
                    <td class="p-3 text-right font-mono ${pnlClass}">
                        <div>${formatNumber(pnlUSDT, 2)}</div>
                        <div class="text-xs opacity-75">ROE: ${formatNumber(roe, 2)}%</div>
                    </td>
                    <td class="p-3 text-right font-mono ${pnlClass}">${formatNumber(pnlPercent, 2)}%</td>
                    <td class="p-3 text-center">
                        <button onclick='openPositionModal(${JSON.stringify({
                            symbol: config.symbol,
                            side: positionSide,
                            entryPrice,
                            currentPrice,
                            stopPrice,
                            leverage,
                            positionSize,
                            pnlUSDT,
                            pnlPercent,
                            roe,
                            tp1Price: tp_levels.tp1.price,
                            tp1Percent: tp_levels.tp1.percent,
                            tp2Price: tp_levels.tp2.price,
                            tp2Percent: tp_levels.tp2.percent,
                            tp3Price: tp_levels.tp3.price,
                            tp3Percent: tp_levels.tp3.percent,
                            tp4Price: tp_levels.tp4.price,
                            tp4Percent: tp_levels.tp4.percent,
                            tp_hits
                        })})'
                        class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors duration-200">
                            Details
                        </button>
                    </td>
                </tr>`;

                    } catch (error) {
                        console.error(`Error processing ${config.symbol}:`, error);
                    }
                }

                if (!activePositionsExist) {
                    tableContent = `
            <tr>
                <td colspan="8" class="p-4 text-center text-gray-500 dark:text-gray-400">
                    ‡πÑ‡∏°‡πà‡∏°‡∏µ Active Positions
                </td>
            </tr>`;
                }

                $('#active-positions').html(tableContent);

            } catch (error) {
                console.error('Error updating active positions:', error);
                $('#active-positions').html(`
        <tr>
            <td colspan="8" class="p-4 text-center text-red-500">
                ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${error.message}
            </td>
        </tr>`);
            }
        }

        // Modal function to show position details
        function openPositionModal(position) {
            // Update modal title
            $('#modal-title').text(`${position.symbol} Position Details`);

            // Basic Info
            $('#modal-symbol').text(position.symbol);
            $('#modal-side').text(position.side.toUpperCase())
                .removeClass('text-green-500 text-red-500')
                .addClass(position.side === 'buy' ? 'text-green-500' : 'text-red-500');
            $('#modal-entry').text(formatNumber(position.entryPrice, 4));
            $('#modal-current').text(formatNumber(position.currentPrice, 4));
            $('#modal-sl').text(formatNumber(position.stopPrice, 4));

            // Additional Info
            $('#modal-leverage').text(`${position.leverage}x`);
            $('#modal-size').text(formatNumber(position.positionSize, 4));
            $('#modal-pnl').text(formatNumber(position.pnlUSDT, 2))
                .removeClass('text-green-500 text-red-500')
                .addClass(position.pnlUSDT >= 0 ? 'text-green-500' : 'text-red-500');
            $('#modal-roe').text(`${formatNumber(position.roe, 2)}%`)
                .removeClass('text-green-500 text-red-500')
                .addClass(position.roe >= 0 ? 'text-green-500' : 'text-red-500');

            // Take Profit Levels
            const tp_levels = [
                { price: position.tp1Price, percent: position.tp1Percent, hit: position.tp_hits?.tp1 },
                { price: position.tp2Price, percent: position.tp2Percent, hit: position.tp_hits?.tp2 },
                { price: position.tp3Price, percent: position.tp3Percent, hit: position.tp_hits?.tp3 },
                { price: position.tp4Price, percent: position.tp4Percent, hit: position.tp_hits?.tp4 }
            ];

            tp_levels.forEach((tp, index) => {
                $(`#modal-tp${index + 1}-price`).text(formatNumber(tp.price, 4));
                $(`#modal-tp${index + 1}-percent`).html(`${tp.hit ? '‚úì ' : ''}${formatNumber(tp.percent, 2)}%`);
            });

            // Show modal
            $('#position-modal').removeClass('hidden').addClass('flex');
        }
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        function updateTable(trades) {
            const feePercentage = getFeePercentage();
            let tableContent = '';

            trades.slice(0, 10).forEach(function (trade) {
                // Calculate fees based on position size
                const entryPositionSize = trade.entry_price * trade.amount;
                const exitPositionSize = trade.exit_price * trade.amount;
                const entryFee = feePercentage ? (entryPositionSize * feePercentage / 100) : 0;
                const exitFee = feePercentage ? (exitPositionSize * feePercentage / 100) : 0;
                const totalFees = entryFee + exitFee;

                // Calculate net profit/loss
                const netProfit = trade.profit_loss - totalFees;
                const netProfitPercentage = trade.profit_loss_percentage - (feePercentage ? feePercentage * 2 : 0);

                const isProfitPositive = netProfit >= 0;
                const profitLossClass = isProfitPositive ? 'text-green-500' : 'text-red-500';

                tableContent += `
            <tr class="border-b border-gray-200 dark:border-dark-600 hover:bg-gray-50 dark:hover:bg-dark-700 transition-colors duration-200">
                <td class="p-3 font-mono text-sm">${new Date(trade.timestamp).toLocaleString('th-TH')}</td>
                <td class="p-3 font-semibold">${trade.symbol}</td>
                <td class="p-3">${trade.action}</td>
                <td class="p-3 text-right font-mono">${formatNumber(trade.entry_price, 4)}</td>
                <td class="p-3 text-right font-mono">${formatNumber(trade.exit_price, 4)}</td>
                <td class="p-3 text-right font-mono">${formatNumber(trade.amount, 6)}</td>
                <td class="p-3 text-right font-mono ${profitLossClass}">
                    ${formatNumber(netProfit)}${feePercentage ? ` (Fee: ${formatNumber(totalFees)})` : ''}
                </td>
                <td class="p-3 text-right font-mono ${profitLossClass}">
                    ${formatNumber(netProfitPercentage)}%
                </td>
                <td class="p-3 text-sm">${trade.reason}</td>
            </tr>`;
            });

            if (trades.length === 0) {
                tableContent = `
            <tr>
                <td colspan="9" class="p-4 text-center text-gray-500 dark:text-gray-400">
                    ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î
                </td>
            </tr>`;
            }

            $('#trade-records').html(tableContent);
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
        function updateStats(stats) {
            function getColorClass(value) {
                return value >= 0 ? 'text-green-500' : 'text-red-500';
            }

            // Update profits
            $('#daily-profit').text(formatNumber(stats.daily_profit))
                .removeClass('text-green-500 text-red-500')
                .addClass(getColorClass(stats.daily_profit));
            $('#weekly-profit').text(formatNumber(stats.weekly_profit))
                .removeClass('text-green-500 text-red-500')
                .addClass(getColorClass(stats.weekly_profit));
            $('#monthly-profit').text(formatNumber(stats.monthly_profit))
                .removeClass('text-green-500 text-red-500')
                .addClass(getColorClass(stats.monthly_profit));
            $('#total-profit').text(formatNumber(stats.total_profit))
                .removeClass('text-green-500 text-red-500')
                .addClass(getColorClass(stats.total_profit));

            // Update counts
            $('#daily-trades').text(stats.daily_trades);
            $('#weekly-trades').text(stats.weekly_trades);
            $('#monthly-trades').text(stats.monthly_trades);
            $('#total-trades').text(stats.total_trades);

            // Update averages
            $('#avg-daily-profit').text(formatNumber(stats.avg_daily_profit));
            $('#avg-weekly-profit').text(formatNumber(stats.avg_weekly_profit));
            $('#avg-monthly-profit').text(formatNumber(stats.avg_monthly_profit));
            $('#avg-total-profit').text(formatNumber(stats.avg_total_profit));
            $('#win-rate').text(formatNumber(stats.win_rate) + '%');

            // Update other stats
            $('#max-profit').text(formatNumber(stats.max_profit));
            $('#min-profit').text(formatNumber(stats.min_profit));
            $('#avg-profit').text(formatNumber(stats.avg_profit));
        }
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏µ‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°
        function getRandomColor() {
            const colors = [
                '#2563eb', '#7c3aed', '#db2777', '#dc2626', '#ea580c',
                '#65a30d', '#0d9488', '#0284c7', '#6366f1', '#9333ea'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Å‡∏£‡∏≤‡∏ü
        function updateCumulativeProfitChart(trades) {
            const isDark = document.documentElement.classList.contains('dark');
            const chartType = $('input[name="chartType"]:checked').val();
            const feePercentage = getFeePercentage();

            let datasets = [];

            if (chartType === 'daily') {
                // Group trades by date and calculate daily profits
                const dailyProfits = trades.reduce((acc, trade) => {
                    const date = new Date(trade.timestamp).toISOString().split('T')[0];

                    // Calculate net profit after fees
                    const entryPositionSize = trade.entry_price * trade.amount;
                    const exitPositionSize = trade.exit_price * trade.amount;
                    const entryFee = feePercentage ? (entryPositionSize * feePercentage / 100) : 0;
                    const exitFee = feePercentage ? (exitPositionSize * feePercentage / 100) : 0;
                    const totalFees = entryFee + exitFee;
                    const netProfit = trade.profit_loss - totalFees;

                    if (!acc[date]) {
                        acc[date] = 0;
                    }
                    acc[date] += netProfit;
                    return acc;
                }, {});

                // Convert to array and sort by date
                const sortedDates = Object.keys(dailyProfits).sort();
                let cumulativeProfit = 0;
                const dailyData = sortedDates.map(date => {
                    cumulativeProfit += dailyProfits[date];
                    return {
                        x: new Date(date),
                        y: cumulativeProfit
                    };
                });

                datasets = [{
                    label: '‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∞‡∏™‡∏°‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç',
                    data: dailyData,
                    fill: false,
                    borderColor: '#2563eb',
                    borderWidth: 2,
                    tension: 0.1,
                    pointRadius: 3,
                    pointHoverRadius: 5
                }];
            } else {
                // Original cumulative profit chart code
                const symbols = [...new Set(trades.map(trade => trade.symbol))];
                datasets = symbols.map(symbol => {
                    const symbolTrades = trades.filter(trade => trade.symbol === symbol)
                        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                    let cumulativeProfit = 0;
                    const data = symbolTrades.map((trade, index) => {
                        const entryPositionSize = trade.entry_price * trade.amount;
                        const exitPositionSize = trade.exit_price * trade.amount;
                        const entryFee = feePercentage ? (entryPositionSize * feePercentage / 100) : 0;
                        const exitFee = feePercentage ? (exitPositionSize * feePercentage / 100) : 0;
                        const totalFees = entryFee + exitFee;
                        const netProfit = trade.profit_loss - totalFees;
                        cumulativeProfit += netProfit;

                        return {
                            x: chartType === 'date' ? new Date(trade.timestamp) : index + 1,
                            y: cumulativeProfit
                        };
                    });

                    return {
                        label: symbol,
                        data: data,
                        fill: false,
                        borderColor: getRandomColor(),
                        borderWidth: 2,
                        tension: 0.1,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    };
                });
            }

            const options = {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        type: chartType === 'trade' ? 'linear' : 'time',
                        time: chartType !== 'trade' ? {
                            unit: 'day',
                            tooltipFormat: 'PPP'
                        } : undefined,
                        grid: {
                            color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                            color: isDark ? '#9ca3af' : '#4b5563'
                        },
                        title: {
                            display: true,
                            text: chartType === 'trade' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ó‡∏£‡∏î' : '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà',
                            color: isDark ? '#9ca3af' : '#4b5563'
                        }
                    },
                    y: {
                        grid: {
                            color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                            color: isDark ? '#9ca3af' : '#4b5563',
                            callback: function (value) {
                                return formatNumber(value);
                            }
                        },
                        title: {
                            display: true,
                            text: '‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∞‡∏™‡∏°',
                            color: isDark ? '#9ca3af' : '#4b5563'
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: isDark ? '#9ca3af' : '#4b5563',
                            padding: 20,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: isDark ? '#1f2937' : 'white',
                        titleColor: isDark ? '#e5e7eb' : '#1f2937',
                        bodyColor: isDark ? '#e5e7eb' : '#1f2937',
                        borderColor: isDark ? '#374151' : '#e5e7eb',
                        borderWidth: 1,
                        padding: 12,
                        callbacks: {
                            label: function (context) {
                                return `${context.dataset.label}: ${formatNumber(context.parsed.y)}`;
                            }
                        }
                    }
                }
            };

            if (cumulativeProfitChart) {
                cumulativeProfitChart.destroy();
            }

            cumulativeProfitChart = new Chart(
                document.getElementById('cumulativeProfitChart'),
                {
                    type: 'line',
                    data: { datasets: datasets },
                    options: options
                }
            );
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        function filterTrades() {
            const selectedSymbol = $('#symbolFilter').val();
            const startDate = $('#startDate').val() ? new Date($('#startDate').val()) : null;
            const endDate = $('#endDate').val() ? new Date($('#endDate').val()) : null;

            let filteredTrades = allTrades;

            if (selectedSymbol !== 'all') {
                filteredTrades = filteredTrades.filter(trade => trade.symbol === selectedSymbol);
            }

            if (startDate) {
                filteredTrades = filteredTrades.filter(trade => new Date(trade.timestamp) >= startDate);
            }

            if (endDate) {
                const adjustedEndDate = new Date(endDate);
                adjustedEndDate.setDate(adjustedEndDate.getDate() + 1);
                filteredTrades = filteredTrades.filter(trade => new Date(trade.timestamp) < adjustedEndDate);
            }

            updateTable(filteredTrades);
            const stats = calculateStats(filteredTrades);
            updateStats(stats);
            updateCumulativeProfitChart(filteredTrades);
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
        $(document).ready(function () {
            // Dark Mode Toggle
            $('#darkModeToggle').click(function () {
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('darkMode', document.documentElement.classList.contains('dark'));
                if (cumulativeProfitChart) {
                    filterTrades();
                }
            });

            // Load Dark Mode Preference
            if (localStorage.getItem('darkMode') === 'true') {
                document.documentElement.classList.add('dark');
            }

            // Load Initial Data
            async function loadAllTrades() {
                try {
                    const indexResponse = await fetch('json/index.json');
                    if (!indexResponse.ok) throw new Error('Cannot load symbols');
                    const symbolConfigs = await indexResponse.json();

                    allTrades = [];
                    for (const config of symbolConfigs) {
                        try {
                            const response = await fetch(`json/trade_records/${config.symbol}.json`);
                            if (response.ok) {
                                const trades = await response.json();
                                allTrades = allTrades.concat(trades);
                            }
                        } catch (error) {
                            console.log(`No trades found for ${config.symbol}`);
                        }
                    }

                    allTrades.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                    // Populate symbol filter
                    const uniqueSymbols = [...new Set(allTrades.map(trade => trade.symbol))];
                    $('#symbolFilter').empty().append('<option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>');
                    uniqueSymbols.sort().forEach(symbol => {
                        $('#symbolFilter').append(`<option value="${symbol}">${symbol}</option>`);
                    });

                    // Set initial date range
                    if (allTrades.length > 0) {
                        const dates = allTrades.map(trade => new Date(trade.timestamp));
                        const earliestDate = new Date(Math.min.apply(null, dates));
                        const latestDate = new Date(Math.max.apply(null, dates));

                        $('#startDate').val(earliestDate.toISOString().split('T')[0]);
                        $('#endDate').val(latestDate.toISOString().split('T')[0]);
                    }

                    filterTrades();
                } catch (error) {
                    console.error('Error loading trade data:', error);
                    $('#trade-records').html(`
                    <tr>
                        <td colspan="9" class="p-4 text-center text-red-500">
                            ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${error.message}
                        </td>
                    </tr>
                `);
                }
            }

            // Start updates
            loadAllTrades();
            setInterval(updateActivePositions, 1000);

            // Event Bindings
            $('#applyFilter').click(filterTrades);
            $('input[name="chartType"]').change(filterTrades);
            $('#symbolFilter, #startDate, #endDate').change(function () {
                $('#applyFilter').click();
            });
            $('#feePercentage').on('input', function () {
                getFeePercentage();
                filterTrades();
            });
        });
    </script>

</body>